{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Detalle de Usuario: {{ usuario_a_ver.username }}</h1>

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} p-3 rounded-md shadow-sm mb-2" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-gray-600 font-semibold">Nombre de Usuario:</p>
                <p class="text-gray-800">{{ usuario_a_ver.username }}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Email:</p>
                <p class="text-gray-800">{{ usuario_a_ver.email|default:"N/A" }}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Nombre:</p>
                <p class="text-gray-800">{{ usuario_a_ver.first_name|default:"N/A" }}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Apellido:</p>
                <p class="text-gray-800">{{ usuario_a_ver.last_name|default:"N/A" }}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Empresa:</p>
                <p class="text-gray-800">{{ usuario_a_ver.empresa.nombre|default:"N/A" }}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Activo:</p>
                <p class="text-gray-800">{% if usuario_a_ver.is_active %}Sí{% else %}No{% endif %}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Staff:</p>
                <p class="text-gray-800">{% if usuario_a_ver.is_staff %}Sí{% else %}No{% endif %}</p>
            </div>
            <div>
                <p class="text-gray-600 font-semibold">Superusuario:</p>
                <p class="text-gray-800">{% if usuario_a_ver.is_superuser %}Sí{% else %}No{% endif %}</p>
            </div>
            {% if usuario_a_ver.last_login %}
            <div>
                <p class="text-gray-600 font-semibold">Último Login:</p>
                <p class="text-gray-800">{{ usuario_a_ver.last_login|date:"d M Y H:i" }}</p>
            </div>
            {% endif %}
            {% if usuario_a_ver.date_joined %}
            <div>
                <p class="text-gray-600 font-semibold">Fecha de Registro:</p>
                <p class="text-gray-800">{{ usuario_a_ver.date_joined|date:"d M Y H:i" }}</p>
            </div>
            {% endif %}
        </div>

        <div class="mt-6 flex justify-end space-x-3">
            {% if perms.core.change_customuser %}
            <a href="{% url 'core:editar_usuario' usuario_a_ver.pk %}" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                <i class="fas fa-edit mr-2"></i> Editar Usuario
            </a>
            {% if user.is_superuser %} {# Solo superusuarios pueden cambiar la contraseña de otros usuarios #}
            <a href="{% url 'core:change_user_password' usuario_a_ver.pk %}" class="bg-yellow-600 hover:bg-yellow-800 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                <i class="fas fa-key mr-2"></i> Cambiar Contraseña
            </a>
            {% endif %}
            {% endif %}
            {% if perms.core.delete_customuser %}
            {# Botón que abre el modal de confirmación #}
            <button type="button" 
                    onclick="showDeleteModal('{% url 'core:eliminar_usuario' usuario_a_ver.pk %}', '{{ usuario_a_ver.username }}')" 
                    class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                Eliminar usuario
            </button>
            {% endif %}
            <a href="{% url 'core:listar_usuarios' %}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                Volver al listado
            </a>
        </div>
    </div>

    {# Modal de Confirmación de Eliminación #}
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Eliminación</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        ¿Estás seguro de que quieres eliminar a <span id="objectToDeleteName" class="font-bold"></span>? Esta acción no se puede deshacer.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Eliminar
                    </button>
                    <button id="cancelDeleteButton" class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showDeleteModal(deleteUrl, objectName) {
        const deleteModal = document.getElementById('deleteModal');
        const objectToDeleteName = document.getElementById('objectToDeleteName');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        objectToDeleteName.textContent = objectName;
        confirmDeleteButton.onclick = function() {
            // Instead of window.location.href, submit a form for POST request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;

            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}'; // Django's CSRF token
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        };
        cancelDeleteButton.onclick = function() {
            deleteModal.classList.add('hidden');
        };
        deleteModal.classList.remove('hidden');
    }
</script>
{% endblock %}
